[('linux-2.6.23/drivers/scsi/libata-scsi.c.orig',
  'linux-2.6.23/drivers/scsi/libata-scsi.c',
  '--- linux-2.6.23/drivers/scsi/libata-scsi.c.orig\n+++ linux-2.6.23/drivers/scsi/libata-scsi.c\n@@ -158,10 +158,10 @@\n{\nint rc = 0;\nu8 scsi_cmd[MAX_COMMAND_SIZE];\n-\tu8 args[4], *argbuf = NULL;\n+\tu8 args[4], *argbuf = NULL, *sensebuf = NULL;\nint argsize = 0;\n-\tstruct scsi_sense_hdr sshdr;\nenum dma_data_direction data_dir;\n+\tint cmd_result;\n\nif (arg == NULL)\nreturn -EINVAL;\n@@ -169,6 +169,10 @@\nif (copy_from_user(args, arg, sizeof(args)))\nreturn -EFAULT;\n\n+\tsensebuf = kzalloc(SCSI_SENSE_BUFFERSIZE, GFP_NOIO);\n+\tif (!sensebuf)\n+\t\treturn -ENOMEM;\n+\nmemset(scsi_cmd, 0, sizeof(scsi_cmd));\n\nif (args[3]) {\n@@ -185,7 +189,7 @@\ndata_dir = DMA_FROM_DEVICE;\n} else {\nscsi_cmd[1]  = (3 << 1); /* Non-data */\n-\t\t/* scsi_cmd[2] is already 0 -- no off.line, cc, or data xfer */\n+\t\tscsi_cmd[2]  = 0x20;     /* cc but no off.line or data xfer */\ndata_dir = DMA_NONE;\n}\n\n@@ -204,18 +208,47 @@\n\n/* Good values for timeout and retries?  Values below\nfrom scsi_ioctl_send_command() for default case... */\n-\tif (scsi_execute_req(scsidev, scsi_cmd, data_dir, argbuf, argsize,\n-\t\t\t     &sshdr, (10*HZ), 5)) {\n+\tcmd_result = scsi_execute(scsidev, scsi_cmd, data_dir, argbuf, argsize,\n+\t                          sensebuf, (10*HZ), 5, 0);\n+\n+\tif ((cmd_result>>24) == DRIVER_SENSE) {   /* sense data available */\n+\t\tu8 *desc = sensebuf + 8;\n+\t\tcmd_result &= ~(0xFF<<24); /* DRIVER_SENSE is not an error */\n+\n+\t\t/* If we set cc then ATA pass-through will cause a\n+\t\t * check condition even if no error. Filter that. */\n+\t\tif (cmd_result & SAM_STAT_CHECK_CONDITION) {\n+\t\t\tstruct scsi_sense_hdr sshdr;\n+\t\t\tscsi_normalize_sense(sensebuf, SCSI_SENSE_BUFFERSIZE,\n+\t\t\t                      &sshdr);\n+\t\t\tif (sshdr.sense_key==0 &&\n+\t\t\t    sshdr.asc==0 && sshdr.ascq==0)\n+\t\t\t\tcmd_result &= ~SAM_STAT_CHECK_CONDITION;\n+\t\t}\n+\n+\t\t/* Send userspace a few ATA registers (same as drivers/ide) */\n+\t\tif (sensebuf[0] == 0x72 &&     /* format is "descriptor" */\n+\t\t    desc[0] == 0x09 ) {        /* code is "ATA Descriptor" */\n+\t\t\targs[0] = desc[13];    /* status */\n+\t\t\targs[1] = desc[3];     /* error */\n+\t\t\targs[2] = desc[5];     /* sector count (0:7) */\n+\t\t\tif (copy_to_user(arg, args, sizeof(args)))\n+\t\t\t\trc = -EFAULT;\n+\t\t}\n+\t}\n+\n+\n+\tif (cmd_result) {\nrc = -EIO;\ngoto error;\n}\n\n-\t/* Need code to retrieve data from check condition? */\n-\nif ((argbuf)\n&& copy_to_user(arg + sizeof(args), argbuf, argsize))\nrc = -EFAULT;\nerror:\n+\tif (sensebuf)\n+\t\tkfree(sensebuf);\nif (argbuf)\nkfree(argbuf);\n')]