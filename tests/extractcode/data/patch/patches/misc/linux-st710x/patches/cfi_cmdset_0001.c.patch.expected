[('linux-2.6.23/drivers/mtd/chips/cfi_cmdset_0001.c.orig',
  'linux-2.6.23/drivers/mtd/chips/cfi_cmdset_0001.c',
  '--- linux-2.6.23/drivers/mtd/chips/cfi_cmdset_0001.c.orig\n+++ linux-2.6.23/drivers/mtd/chips/cfi_cmdset_0001.c\n@@ -39,11 +39,15 @@\n#include <linux/mtd/compatmac.h>\n#include <linux/mtd/cfi.h>\n\n+#ifdef CONFIG_SH_MOTOROLA_VIP19XX\n+#include <asm/vip19xx.h>\n+#endif\n+\n/* #define CMDSET0001_DISABLE_ERASE_SUSPEND_ON_WRITE */\n/* #define CMDSET0001_DISABLE_WRITE_SUSPEND */\n\n// debugging, turns off buffer write mode if set to 1\n-#define FORCE_WORD_WRITE 0\n+#define FORCE_WORD_WRITE 1\n\n#define MANUFACTURER_INTEL\t0x0089\n#define I82802AB\t0x00ad\n@@ -103,7 +107,7 @@\n};\n\n#undef DEBUG_LOCK_BITS\n-#define DEBUG_CFI_FEATURES\n+#undef DEBUG_CFI_FEATURES\n\n#ifdef DEBUG_CFI_FEATURES\nstatic void cfi_tell_features(struct cfi_pri_intelext *extp)\n@@ -656,6 +660,9 @@\nmap_word status, status_OK = CMD(0x80), status_PWS = CMD(0x01);\nunsigned long timeo;\nstruct cfi_pri_intelext *cfip = cfi->cmdset_priv;\n+#ifdef CONFIG_SH_MOTOROLA_VIP19XX\n+\tvoid __iomem *emi;\n+#endif\n\nresettime:\ntimeo = jiffies + HZ;\n@@ -716,6 +723,13 @@\nspin_unlock(&shared->lock);\n}\n\n+#ifdef CONFIG_SH_MOTOROLA_VIP19XX\n+\t/* Enable chip select on the EMI */\n+\temi = ioremap_nocache(VIP19XX_EMI_CONFIG_BASE, VIP19XX_EMI_CONFIG_SIZE);\n+\tVIP19XX_EMI_ENABLE_CS(emi, VIP19XX_NOR_FLASH_EMI_BANK);\n+\tiounmap(emi);\n+#endif\n+\nswitch (chip->state) {\n\ncase FL_STATUS:\n@@ -820,6 +834,9 @@\nstatic void put_chip(struct map_info *map, struct flchip *chip, unsigned long adr)\n{\nstruct cfi_private *cfi = map->fldrv_priv;\n+#ifdef CONFIG_SH_MOTOROLA_VIP19XX\n+\tvoid __iomem *emi;\n+#endif\n\nif (chip->priv) {\nstruct flchip_shared *shared = chip->priv;\n@@ -888,6 +905,12 @@\ndefault:\nprintk(KERN_ERR "%s: put_chip() called with oldstate %d!!\\n", map->name, chip->oldstate);\n}\n+#ifdef CONFIG_SH_MOTOROLA_VIP19XX\n+\t/* Disable chip select on the EMI */\n+\temi = ioremap_nocache(VIP19XX_EMI_CONFIG_BASE, VIP19XX_EMI_CONFIG_SIZE);\n+\tVIP19XX_EMI_DISABLE_CS(emi, VIP19XX_NOR_FLASH_EMI_BANK);\n+\tiounmap(emi);\n+#endif\nwake_up(&chip->wq);\n}\n')]