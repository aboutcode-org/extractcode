[('linux-2.6.23/arch/sh/kernel/process.c.orig',
  'linux-2.6.23/arch/sh/kernel/process.c',
  '--- linux-2.6.23/arch/sh/kernel/process.c.orig\n+++ linux-2.6.23/arch/sh/kernel/process.c\n@@ -20,6 +20,7 @@\n#include <linux/reboot.h>\n#include <linux/fs.h>\n#include <linux/preempt.h>\n+#include <linux/notifier.h>\n#include <asm/uaccess.h>\n#include <asm/mmu_context.h>\n#include <asm/pgalloc.h>\n@@ -28,6 +29,7 @@\n#include <asm/watchdog.h>\n\nstatic int hlt_counter;\n+static ATOMIC_NOTIFIER_HEAD(restart_notifier_list);\nint ubc_usercnt = 0;\n\nvoid (*pm_idle)(void);\n@@ -98,20 +100,47 @@\n}\n}\n\n-static void watchdog_trigger_immediate(void)\n+int register_machine_restart_notifier(struct notifier_block * nb)\n{\n-\tsh_wdt_write_cnt(0xFF);\n-\tsh_wdt_write_csr(0xC2);\n+\treturn atomic_notifier_chain_register(&restart_notifier_list, nb);\n+}\n+int unregister_machine_restart_notifier(struct notifier_block * nb)\n+{\n+\treturn atomic_notifier_chain_unregister(&restart_notifier_list, nb);\n}\n+EXPORT_SYMBOL(register_machine_restart_notifier);\n+EXPORT_SYMBOL(unregister_machine_restart_notifier);\n\nvoid machine_restart(char *__unused)\n{\n+\t__u8 csr;\n+\tatomic_notifier_call_chain(&restart_notifier_list, 0, NULL);\n+\tprintk("Watchdog reset!\\n");\n/* Use watchdog timer to trigger reset */\nlocal_irq_disable();\n-\twatchdog_trigger_immediate();\n+\tcsr = sh_wdt_read_csr();\n+\tcsr &= ~WTCSR_CKS_4096;\n+\tcsr &= ~WTCSR_TME;\n+#ifdef CONFIG_CPU_SUBTYPE_STX7105\n+#define WTCSR2 0xFFC0001C\n+\tcsr |= WTCSR_WT | WTCSR_CKS_1024;\n+\tsh_wdt_write_csr(csr);\n+\tctrl_outw(0xAA01,WTCSR2);\n+\tsh_wdt_write_cnt(0xFF);\n+#else\n+\tcsr |= WTCSR_WT | WTCSR_CKS_4096;\n+\tsh_wdt_write_csr(csr);\n+\tsh_wdt_write_cnt(0);\n+#endif\n+\tcsr = sh_wdt_read_csr();\n+\tcsr |= WTCSR_TME;\n+\tcsr &= ~WTCSR_RSTS;\n+\tsh_wdt_write_csr(csr);\nwhile (1) {};\n}\n\n+EXPORT_SYMBOL(machine_restart);\n+\nvoid machine_halt(void)\n{\nlocal_irq_disable();')]